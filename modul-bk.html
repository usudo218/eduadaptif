<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modul BK - ELANG DIGITAL</title>
    <style>
        :root {
            --warna-utama: #E11D48; 
            --warna-merah: #EF4444; 
            --warna-merah-hover: #DC2626;
            --warna-kuning: #F59E0B; 
            --warna-latar: #F8FAFC; 
            --warna-teks-utama: #0F172A; 
            --latar-mentor: #FFE4E6; 
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { background-color: var(--warna-latar); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .app-container { background: white; width: 100%; max-width: 650px; border-radius: 20px; box-shadow: 0 20px 25px rgba(0,0,0,0.1); overflow: hidden; margin-top: 20px; display: flex; flex-direction: column;}
        .header { background: var(--warna-utama); color: white; padding: 50px 20px 30px; text-align: center; position: relative; }
        .btn-header { position: absolute; top: 15px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; height: 36px; width: 90px; border-radius: 8px; text-decoration: none; color: white; border: 1px solid rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.15); transition: 0.3s; }
        .btn-header:hover { background: rgba(255, 255, 255, 0.3); }
        .home-pos { left: 15px; } .logout-pos { right: 15px; }
        .content { padding: 30px 25px; }
        
        /* MENTOR BOX */
        .mentor-box { display: flex; gap: 15px; background: var(--latar-mentor); padding: 20px; border-radius: 16px; margin-bottom: 25px; border-left: 5px solid var(--warna-utama); align-items: center; transition: 0.3s; }
        .mentor-box.peringatan { border-left-color: var(--warna-kuning); background-color: #FEF3C7; }
        .mentor-avatar { width: 65px; height: 65px; border-radius: 50%; overflow: hidden; border: 2px solid var(--warna-utama); background: white; flex-shrink: 0; }
        
        .teks-materi { background: #ffffff; padding: 10px 5px; height: 480px; overflow-y: auto; line-height: 1.8; font-size: 1.05rem; }
        .btn-opsi { background: white; border: 1.5px solid #e2e8f0; padding: 18px 20px; border-radius: 12px; text-align: left; width: 100%; margin-bottom: 12px; cursor: pointer; transition: 0.2s; }
        .btn-opsi.terpilih { background: var(--warna-utama); border-color: var(--warna-utama); color: white; font-weight: 600; }
        
        .btn-action { width: 100%; background: var(--warna-utama); color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-bantuan { background: var(--warna-kuning); color: white; margin-bottom: 10px;}
        .btn-disabled { background: #9CA3AF; cursor: not-allowed; opacity: 0.5; }
        .btn-remedial { background: var(--warna-kuning); color: white; margin-top: 10px; }
        
        .pdf-box { background: #FFF1F2; padding: 20px; border: 1px dashed var(--warna-utama); border-radius: 16px; text-align: center; margin: 25px 0; }
        .btn-pdf { background: var(--warna-merah); color: white; text-decoration: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; display: inline-block; }
        .angka-skor { font-size: 5rem; font-weight: 900; text-align: center; color: var(--warna-utama); margin: 10px 0; }
        .area-konten { display: none; }
        .footer { padding: 25px; text-align: center; font-size: 0.85rem; color: #94a3b8; background: #f8fafc; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <a href="index.html" class="btn-header home-pos">üè† Home</a>
            <button id="btn-logout" class="btn-header logout-pos" onclick="logoutSiswa()" style="display: none;">üö™ Logout</button>
            <h1>Modul Berpikir Komputasi</h1>
            <p>Elang Digital - SMA Negeri 1 Muncar</p>
        </div>
        <div class="content">
            <div id="area-login" class="area-konten" style="display:block">
                <div style="text-align:center">
                    <img src="images/Pak-Agus.png" style="width:110px; border-radius:50%; border:3px solid var(--warna-utama); margin-bottom:15px;">
                    <h2>Halo, Para Petualang Muda </h2>
                    <p>Saya Pak Agus, saya akan menemanimu berpetualangan...</p>
                    <select id="pilih-kelas" style="width:100%; padding:15px; border-radius:12px; margin-bottom:10px;" onchange="filterNama()"><option value="">-- Pilih Kelas --</option></select>
                    <select id="pilih-nama" style="width:100%; padding:15px; border-radius:12px; margin-bottom:10px;" disabled><option value="">-- Pilih Nama --</option></select>
                    <button class="btn-action" onclick="simpanNamaSiswa()">üß† Masuk Modul</button>
                </div>
            </div>

            <div id="area-mentor-global" style="display: none;">
                <div class="mentor-box" id="kotak-mentor">
                    <div class="mentor-avatar"><img src="images/Pak-Agus.png" style="width:100%"></div>
                    <div class="mentor-message"><b id="ui-guru" style="color:var(--warna-utama); display:block;">Pak Agus :</b><span id="pesan-mentor">Semangat belajar!</span></div>
                </div>
            </div>

            <div id="area-materi" class="area-konten">
                <div class="teks-materi">
                   <div class="pdf-box"><a href="https://drive.google.com/file/d/1JnEyi4GkRpT8bV6PO1mQIMtVnX_lQJRB/view?usp=sharing" target="_blank" class="btn-pdf">üì• Buka Naskah PDF</a></div>
                </div>
                <button class="btn-action" onclick="mulaiKuis()">Logika Siap, Mulai Kuis!</button>
            </div>

            <div id="area-kuis" class="area-konten">
                <h4 id="indikator" style="font-weight:700; color:var(--warna-utama)">Soal 1</h4>
                <h2 id="teks-soal" style="font-size:1.2rem; min-height:60px; margin-bottom:20px;">Memuat soal...</h2>
                <div id="container-opsi"></div>
                <button class="btn-action btn-bantuan" id="tombol-bantuan" onclick="mintaBantuan()">üí° Tanya Pak Agus (-5 Poin)</button>
                <button id="btn-lanjut" class="btn-action btn-disabled" onclick="simpanJawaban()" disabled>Pilih Jawaban Dulu</button>
            </div>

            <div id="area-hasil" class="area-konten">
                <div id="res-nama" style="font-size:1.2rem; font-weight:800; text-align:center; text-transform:uppercase"></div>
                <div class="angka-skor" id="res-skor">0</div>
                <p id="teks-percobaan" style="text-align: center; font-weight: bold; color: var(--warna-utama); margin: 0;"></p>
                <p id="teks-penalti" style="text-align: center; color: var(--warna-merah); margin-top: 5px;"></p>
                
                <div id="wrapper-tombol-hasil">
                    <button id="btn-remedial" class="btn-action btn-remedial" onclick="mulaiKuis()">üîÑ Remedial (Ulangi Kuis)</button>
                    <button class="btn-action" onclick="location.href='index.html'">‚úÖ Selesai & Kembali</button>
                </div>
            </div>
        </div>
        <div class="footer">Design by <b>Agus Suyatno, S.Kom</b><br>&copy; 2026</div>
    </div>

    <script src="soal-bk.js"></script>
    <script src="siswa.js"></script>
    <script>
        let nS="", kS="", dS=[], idx=0, benar=0, terpilih=null, bantuanPakai=false, totalBantuan=0, totalPercobaan=1;

        // Fungsi simpan menyertakan totalPercobaan
        function save(f) { 
            localStorage.setItem('pro_bk', JSON.stringify({
                n:nS, k:kS, f:f, s:dS, i:idx, b:benar, tb:totalBantuan, tp:totalPercobaan
            })); 
        }

        window.onload = function() {
            const p = JSON.parse(localStorage.getItem('pro_bk'));
            if(p){ 
                nS=p.n; kS=p.k; dS=p.s; idx=p.i; benar=p.b; 
                totalBantuan=p.tb; 
                totalPercobaan=p.tp || 1; // Default 1 jika data lama
                document.getElementById('area-mentor-global').style.display="block";
                document.getElementById('btn-logout').style.display="flex";
                if(p.f==='materi') showMateri(); else muatSoal();
            } else { inisialisasi(); }
        };

        function inisialisasi(){
            const sk = document.getElementById('pilih-kelas');
            [...new Set(SISWA_BARU.map(x=>x.kelas))].sort().forEach(k=>{let o=document.createElement('option');o.value=k;o.innerText=k;sk.appendChild(o);});
        }

        function filterNama(){
            const k = document.getElementById('pilih-kelas').value; 
            const sn = document.getElementById('pilih-nama'); 
            sn.innerHTML='<option value="">-- Pilih Nama --</option>';
            if(!k) return sn.disabled=true; sn.disabled=false;
            SISWA_BARU.filter(x=>x.kelas===k).forEach(x=>{let o=document.createElement('option');o.value=x.nama;o.innerText=x.nama;sn.appendChild(o);});
        }

        function simpanNamaSiswa(){ 
            nS=document.getElementById('pilih-nama').value; 
            kS=document.getElementById('pilih-kelas').value; 
            if(!nS) return alert("Pilih Nama!"); 
            document.getElementById('area-mentor-global').style.display="block"; 
            document.getElementById('btn-logout').style.display="flex"; 
            showMateri(); 
        }

        function showMateri(){ 
            hideAll(); 
            document.getElementById('area-materi').style.display='block'; 
            document.getElementById('pesan-mentor').innerText=`Halo ${nS}, ayo belajar!`; 
            save('materi'); 
        }

        function mulaiKuis(){ 
            // Jika masuk sini dari tombol Remedial, totalPercobaan bertambah
            const p = JSON.parse(localStorage.getItem('pro_bk'));
            if (p && p.f === 'hasil') {
                totalPercobaan++;
            }
            
            dS=[...daftarSoalAsli].sort(()=>Math.random()-0.5); 
            idx=0; benar=0; totalBantuan=0; 
            muatSoal(); 
        }

        function muatSoal(){
            hideAll(); 
            document.getElementById('area-kuis').style.display='block'; 
            terpilih=null; bantuanPakai=false;
            let q=dS[idx]; 
            document.getElementById('indikator').innerText=`Soal ${idx+1}/${dS.length}`;
            document.getElementById('teks-soal').innerText=q.p;
            document.getElementById('tombol-bantuan').disabled=false; 
            document.getElementById('tombol-bantuan').classList.remove('btn-disabled');
            document.getElementById('kotak-mentor').className="mentor-box"; 
            document.getElementById('pesan-mentor').innerText="Gunakan logika terbaikmu!";
            const bl=document.getElementById('btn-lanjut'); 
            bl.disabled=true; bl.className="btn-action btn-disabled";
            const co=document.getElementById('container-opsi'); co.innerHTML='';
            q.o.forEach((t,i)=>{
                const b=document.createElement('button'); b.className='btn-opsi'; b.innerText=t;
                b.onclick=()=>{
                    document.querySelectorAll('.btn-opsi').forEach(x=>x.classList.remove('terpilih')); 
                    b.classList.add('terpilih'); terpilih=i; 
                    bl.disabled=false; bl.className="btn-action";
                };
                co.appendChild(b);
            });
            save('kuis');
        }

        function mintaBantuan(){
            if(bantuanPakai) return; 
            bantuanPakai=true; totalBantuan++;
            document.getElementById('kotak-mentor').className="mentor-box peringatan";
            document.getElementById('pesan-mentor').innerText=`Pak Agus: ${dS[idx].b}`;
            document.getElementById('tombol-bantuan').disabled=true; 
            document.getElementById('tombol-bantuan').classList.add('btn-disabled');
        }

        function simpanJawaban(){ 
            if(terpilih===dS[idx].k) benar++; 
            idx++; 
            if(idx<dS.length) muatSoal(); 
            else tampilkanHasil(); 
        }

        function tampilkanHasil(){
            hideAll(); 
            document.getElementById('area-hasil').style.display='block';
            let skorAwal = Math.round((benar/dS.length)*100); 
            let penalti = totalBantuan*5; 
            let skorAkhir = Math.max(0, skorAwal-penalti);
            
            document.getElementById('res-nama').innerText=nS; 
            document.getElementById('res-skor').innerText=skorAkhir;
            document.getElementById('teks-percobaan').innerText = `Percobaan Ke-${totalPercobaan}`;
            document.getElementById('teks-penalti').innerText = totalBantuan > 0 ? `(Penalti bantuan: -${penalti} poin)` : "";
            
            // Tampilkan tombol remedial hanya jika skor di bawah 100 (atau sesuai kriteria Anda)
            const btnRemed = document.getElementById('btn-remedial');
            if(skorAkhir >= 100) {
                btnRemed.style.display = 'none';
                document.getElementById('pesan-mentor').innerText = "Luar biasa! Logikamu sempurna.";
            } else {
                btnRemed.style.display = 'block';
                document.getElementById('pesan-mentor').innerText = "Jangan menyerah, asah terus logika berpikirmu!";
            }

            // Kirim data ke Spreadsheet (termasuk totalPercobaan)
            const params = new URLSearchParams({
                namaSiswa: nS, 
                kelasSiswa: kS, 
                modul: "BK", 
                skor: skorAkhir, 
                bantuan: totalBantuan, 
                percobaan: totalPercobaan,
                status: skorAkhir >= 100 ? "TUNTAS" : "REMEDIAL"
            });
            
            fetch("https://script.google.com/macros/s/AKfycbzgcZKAlz7gOP2uEz9fHhpspj726hqYP1F7nYo8FQybaY_cStqxiZ7YA8NNQ0CMdLrV/exec?" + params, {mode:'no-cors'});
            
            save('hasil');
        }

        function hideAll(){ document.querySelectorAll('.area-konten').forEach(a=>a.style.display='none'); }
        
        function logoutSiswa(){ 
            if(confirm("Keluar? Progres belajar akan dihapus.")) { 
                localStorage.removeItem('pro_bk'); 
                location.reload(); 
            } 
        }
    </script>
</body>
</html>
